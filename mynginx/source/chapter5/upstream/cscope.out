cscope 15 /mnt/mydata/haoning/mygit/mynginxmodule/mynginx/source/chapter5/upstream               0000010181
	@ngx_http_mytest_module.c

1 
	~<ngx_cÚfig.h
>

2 
	~<ngx_cÜe.h
>

3 
	~<ngx_h‰p.h
>

8 
ngx_h‰p_¡©us_t
 
	m¡©us
;

9 
ngx_¡r_t
 
	mback’dS”v”
;

10 } 
	tngx_h‰p_my‹¡_ùx_t
;

14 
ngx_h‰p_up¡»am_cÚf_t
 
	mup¡»am
;

15 } 
	tngx_h‰p_my‹¡_cÚf_t
;

19 
ngx_h‰p_my‹¡
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

21 
ngx_št_t
 
ngx_h‰p_my‹¡_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
);

22 * 
ngx_h‰p_my‹¡_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
);

23 *
ngx_h‰p_my‹¡_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
);

25 
ngx_št_t


26 
my‹¡_up¡»am_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
);

27 
ngx_št_t


28 
my‹¡_´oûss_¡©us_lše
(
ngx_h‰p_»que¡_t
 *
r
);

31 
ngx_¡r_t
 
	gngx_h‰p_´oxy_hide_h—d”s
[] =

33 
ngx_¡ršg
("Date"),

34 
ngx_¡ršg
("Server"),

35 
ngx_¡ršg
("X-Pad"),

36 
ngx_¡ršg
("X-Accel-Expires"),

37 
ngx_¡ršg
("X-Accel-Redirect"),

38 
ngx_¡ršg
("X-Accel-Limit-Rate"),

39 
ngx_¡ršg
("X-Accel-Buffering"),

40 
ngx_¡ršg
("X-Accel-Charset"),

41 
ngx_nuÎ_¡ršg


45 
ngx_commªd_t
 
	gngx_h‰p_my‹¡_commªds
[] =

49 
ngx_¡ršg
("mytest"),

50 
NGX_HTTP_MAIN_CONF
 | 
NGX_HTTP_SRV_CONF
 | 
NGX_HTTP_LOC_CONF
 | 
NGX_HTTP_LMT_CONF
 | 
NGX_CONF_NOARGS
,

51 
ngx_h‰p_my‹¡
,

52 
NGX_HTTP_LOC_CONF_OFFSET
,

54 
NULL


57 
ngx_nuÎ_commªd


60 
ngx_h‰p_moduË_t
 
	gngx_h‰p_my‹¡_moduË_ùx
 =

62 
NULL
,

63 
NULL
,

65 
NULL
,

66 
NULL
,

68 
NULL
,

69 
NULL
,

71 
ngx_h‰p_my‹¡_ü—‹_loc_cÚf
,

72 
ngx_h‰p_my‹¡_m”ge_loc_cÚf


75 
ngx_moduË_t
 
	gngx_h‰p_my‹¡_moduË
 =

77 
NGX_MODULE_V1
,

78 &
ngx_h‰p_my‹¡_moduË_ùx
,

79 
ngx_h‰p_my‹¡_commªds
,

80 
NGX_HTTP_MODULE
,

81 
NULL
,

82 
NULL
,

83 
NULL
,

84 
NULL
,

85 
NULL
,

86 
NULL
,

87 
NULL
,

88 
NGX_MODULE_V1_PADDING


92 * 
	$ngx_h‰p_my‹¡_ü—‹_loc_cÚf
(
ngx_cÚf_t
 *
cf
)

94 
ngx_h‰p_my‹¡_cÚf_t
 *
mycf
;

96 
mycf
 = (
ngx_h‰p_my‹¡_cÚf_t
 *)
	`ngx_pÿÎoc
(
cf
->
poÞ
, (ngx_http_mytest_conf_t));

97 ià(
mycf
 =ð
NULL
)

99  
NULL
;

104 
mycf
->
up¡»am
.
cÚÃù_timeout
 = 60000;

105 
mycf
->
up¡»am
.
£nd_timeout
 = 60000;

106 
mycf
->
up¡»am
.
»ad_timeout
 = 60000;

107 
mycf
->
up¡»am
.
¡Üe_acûss
 = 0600;

113 
mycf
->
up¡»am
.
bufãršg
 = 0;

114 
mycf
->
up¡»am
.
bufs
.
num
 = 8;

115 
mycf
->
up¡»am
.
bufs
.
size
 = 
ngx_·gesize
;

116 
mycf
->
up¡»am
.
bufãr_size
 = 
ngx_·gesize
;

117 
mycf
->
up¡»am
.
busy_bufãrs_size
 = 2 * 
ngx_·gesize
;

118 
mycf
->
up¡»am
.
‹mp_fže_wr™e_size
 = 2 * 
ngx_·gesize
;

119 
mycf
->
up¡»am
.
max_‹mp_fže_size
 = 1024 * 1024 * 1024;

128 
mycf
->
up¡»am
.
hide_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

129 
mycf
->
up¡»am
.
·ss_h—d”s
 = 
NGX_CONF_UNSET_PTR
;

131  
mycf
;

132 
	}
}

135 *
	$ngx_h‰p_my‹¡_m”ge_loc_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chžd
)

137 
ngx_h‰p_my‹¡_cÚf_t
 *
´ev
 = (ngx_h‰p_my‹¡_cÚf_ˆ*)
·»Á
;

138 
ngx_h‰p_my‹¡_cÚf_t
 *
cÚf
 = (ngx_h‰p_my‹¡_cÚf_ˆ*)
chžd
;

140 
ngx_hash_š™_t
 
hash
;

141 
hash
.
max_size
 = 100;

142 
hash
.
buck‘_size
 = 1024;

143 
hash
.
Çme
 = "proxy_headers_hash";

144 ià(
	`ngx_h‰p_up¡»am_hide_h—d”s_hash
(
cf
, &
cÚf
->
up¡»am
,

145 &
´ev
->
up¡»am
, 
ngx_h‰p_´oxy_hide_h—d”s
, &
hash
)

146 !ð
NGX_OK
)

148  
NGX_CONF_ERROR
;

151  
NGX_CONF_OK
;

152 
	}
}

155 
ngx_št_t


156 
	$my‹¡_up¡»am_ü—‹_»que¡
(
ngx_h‰p_»que¡_t
 *
r
)

161 
ngx_¡r_t
 
back’dQu”yLše
 =

162 
	`ngx_¡ršg
("GET /search?q=%V HTTP/1.1\r\nHost: www.google.com\r\nConnection: close\r\n\r\n");

163 
ngx_št_t
 
qu”yLšeL’
 = 
back’dQu”yLše
.
Ën
 + 
r
->
¬gs
.len - 2;

168 
ngx_buf_t
* 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
r
->
poÞ
, 
qu”yLšeL’
);

169 ià(
b
 =ð
NULL
)

170  
NGX_ERROR
;

172 
b
->
Ï¡
 = b->
pos
 + 
qu”yLšeL’
;

175 
	`ngx_¢´štf
(
b
->
pos
, 
qu”yLšeL’
 ,

176 (*)
back’dQu”yLše
.
d©a
, &
r
->
¬gs
);

179 
r
->
up¡»am
->
»que¡_bufs
 = 
	`ngx_®loc_chaš_lšk
Ô->
poÞ
);

180 ià(
r
->
up¡»am
->
»que¡_bufs
 =ð
NULL
)

181  
NGX_ERROR
;

184 
r
->
up¡»am
->
»que¡_bufs
->
buf
 = 
b
;

185 
r
->
up¡»am
->
»que¡_bufs
->
Ãxt
 = 
NULL
;

187 
r
->
up¡»am
->
»que¡_£Á
 = 0;

188 
r
->
up¡»am
->
h—d”_£Á
 = 0;

190 
r
->
h—d”_hash
 = 1;

191  
NGX_OK
;

192 
	}
}

194 
ngx_št_t


195 
	$my‹¡_´oûss_¡©us_lše
(
ngx_h‰p_»que¡_t
 *
r
)

197 
size_t
 
Ën
;

198 
ngx_št_t
 
rc
;

199 
ngx_h‰p_up¡»am_t
 *
u
;

202 
ngx_h‰p_my‹¡_ùx_t
* 
ùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_my‹¡_moduË
);

203 ià(
ùx
 =ð
NULL
)

205  
NGX_ERROR
;

208 
u
 = 
r
->
up¡»am
;

212 
rc
 = 
	`ngx_h‰p_·r£_¡©us_lše
(
r
, &
u
->
bufãr
, &
ùx
->
¡©us
);

215 ià(
rc
 =ð
NGX_AGAIN
)

217  
rc
;

220 ià(
rc
 =ð
NGX_ERROR
)

222 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

225 
r
->
h‰p_v”siÚ
 = 
NGX_HTTP_VERSION_9
;

226 
u
->
¡©e
->
¡©us
 = 
NGX_HTTP_OK
;

228  
NGX_OK
;

239 ià(
u
->
¡©e
)

241 
u
->
¡©e
->
¡©us
 = 
ùx
->¡©us.
code
;

244 
u
->
h—d”s_š
.
¡©us_n
 = 
ùx
->
¡©us
.
code
;

246 
Ën
 = 
ùx
->
¡©us
.
’d
 - ctx->¡©us.
¡¬t
;

247 
u
->
h—d”s_š
.
¡©us_lše
.
Ën
 =†en;

249 
u
->
h—d”s_š
.
¡©us_lše
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
, 
Ën
);

250 ià(
u
->
h—d”s_š
.
¡©us_lše
.
d©a
 =ð
NULL
)

252  
NGX_ERROR
;

255 
	`ngx_memýy
(
u
->
h—d”s_š
.
¡©us_lše
.
d©a
, 
ùx
->
¡©us
.
¡¬t
, 
Ën
);

260 
u
->
´oûss_h—d”
 = 
my‹¡_up¡»am_´oûss_h—d”
;

264  
	`my‹¡_up¡»am_´oûss_h—d”
(
r
);

265 
	}
}

268 
ngx_št_t


269 
	$my‹¡_up¡»am_´oûss_h—d”
(
ngx_h‰p_»que¡_t
 *
r
)

271 
ngx_št_t
 
rc
;

272 
ngx_bË_–t_t
 *
h
;

273 
ngx_h‰p_up¡»am_h—d”_t
 *
hh
;

274 
ngx_h‰p_up¡»am_maš_cÚf_t
 *
umcf
;

279 
umcf
 = 
	`ngx_h‰p_g‘_moduË_maš_cÚf
(
r
, 
ngx_h‰p_up¡»am_moduË
);

286 
rc
 = 
	`ngx_h‰p_·r£_h—d”_lše
(
r
, &r->
up¡»am
->
bufãr
, 1);

288 ià(
rc
 =ð
NGX_OK
)

291 
h
 = 
	`ngx_li¡_push
(&
r
->
up¡»am
->
h—d”s_š
.
h—d”s
);

292 ià(
h
 =ð
NULL
)

294  
NGX_ERROR
;

297 
h
->
hash
 = 
r
->
h—d”_hash
;

299 
h
->
key
.
Ën
 = 
r
->
h—d”_Çme_’d
 -„->
h—d”_Çme_¡¬t
;

300 
h
->
v®ue
.
Ën
 = 
r
->
h—d”_’d
 -„->
h—d”_¡¬t
;

302 
h
->
key
.
d©a
 = 
	`ngx_²®loc
(
r
->
poÞ
,

303 
h
->
key
.
Ën
 + 1 + h->
v®ue
.len + 1 + h->key.len);

304 ià(
h
->
key
.
d©a
 =ð
NULL
)

306  
NGX_ERROR
;

309 
h
->
v®ue
.
d©a
 = h->
key
.d©¨+ h->key.
Ën
 + 1;

310 
h
->
lowÿ£_key
 = h->
key
.
d©a
 + h->key.
Ën
 + 1 + h->
v®ue
.len + 1;

312 
	`ngx_memýy
(
h
->
key
.
d©a
, 
r
->
h—d”_Çme_¡¬t
, h->key.
Ën
);

313 
h
->
key
.
d©a
[h->key.
Ën
] = '\0';

314 
	`ngx_memýy
(
h
->
v®ue
.
d©a
, 
r
->
h—d”_¡¬t
, h->v®ue.
Ën
);

315 
h
->
v®ue
.
d©a
[h->v®ue.
Ën
] = '\0';

317 ià(
h
->
key
.
Ën
 =ð
r
->
lowÿ£_šdex
)

319 
	`ngx_memýy
(
h
->
lowÿ£_key
, 
r
->
lowÿ£_h—d”
, h->
key
.
Ën
);

323 
	`ngx_¡¾ow
(
h
->
lowÿ£_key
, h->
key
.
d©a
, h->key.
Ën
);

327 
hh
 = 
	`ngx_hash_fšd
(&
umcf
->
h—d”s_š_hash
, 
h
->
hash
,

328 
h
->
lowÿ£_key
, h->
key
.
Ën
);

330 ià(
hh
 && hh->
	`hªdËr
(
r
, 
h
, hh->
off£t
è!ð
NGX_OK
)

332  
NGX_ERROR
;

340 ià(
rc
 =ð
NGX_HTTP_PARSE_HEADER_DONE
)

344 ià(
r
->
up¡»am
->
h—d”s_š
.
£rv”
 =ð
NULL
)

346 
h
 = 
	`ngx_li¡_push
(&
r
->
up¡»am
->
h—d”s_š
.
h—d”s
);

347 ià(
h
 =ð
NULL
)

349  
NGX_ERROR
;

352 
h
->
hash
 = 
	`ngx_hash
(ngx_hash(ngx_hash(ngx_hash(

353 
	`ngx_hash
('s', 'e'), 'r'), 'v'), 'e'), 'r');

355 
	`ngx_¡r_£t
(&
h
->
key
, "Server");

356 
	`ngx_¡r_nuÎ
(&
h
->
v®ue
);

357 
h
->
lowÿ£_key
 = (
u_ch¬
 *) "server";

360 ià(
r
->
up¡»am
->
h—d”s_š
.
d©e
 =ð
NULL
)

362 
h
 = 
	`ngx_li¡_push
(&
r
->
up¡»am
->
h—d”s_š
.
h—d”s
);

363 ià(
h
 =ð
NULL
)

365  
NGX_ERROR
;

368 
h
->
hash
 = 
	`ngx_hash
(ngx_hash(ngx_hash('d', 'a'), 't'), 'e');

370 
	`ngx_¡r_£t
(&
h
->
key
, "Date");

371 
	`ngx_¡r_nuÎ
(&
h
->
v®ue
);

372 
h
->
lowÿ£_key
 = (
u_ch¬
 *) "date";

375  
NGX_OK
;

381 ià(
rc
 =ð
NGX_AGAIN
)

383  
NGX_AGAIN
;

387 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

390  
NGX_HTTP_UPSTREAM_INVALID_HEADER
;

392 
	}
}

395 
	$my‹¡_up¡»am_fš®ize_»que¡
(
ngx_h‰p_»que¡_t
 *
r
, 
ngx_št_t
 
rc
)

397 
	`ngx_log_”rÜ
(
NGX_LOG_DEBUG
, 
r
->
cÚÃùiÚ
->
log
, 0,

399 
	}
}

403 
	$ngx_h‰p_my‹¡
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

405 
ngx_h‰p_cÜe_loc_cÚf_t
 *
þcf
;

410 
þcf
 = 
	`ngx_h‰p_cÚf_g‘_moduË_loc_cÚf
(
cf
, 
ngx_h‰p_cÜe_moduË
);

415 
þcf
->
hªdËr
 = 
ngx_h‰p_my‹¡_hªdËr
;

417  
NGX_CONF_OK
;

418 
	}
}

421 
ngx_št_t


422 
	$ngx_h‰p_my‹¡_hªdËr
(
ngx_h‰p_»que¡_t
 *
r
)

425 
ngx_h‰p_my‹¡_ùx_t
* 
myùx
 = 
	`ngx_h‰p_g‘_moduË_ùx
(
r
, 
ngx_h‰p_my‹¡_moduË
);

426 ià(
myùx
 =ð
NULL
)

428 
myùx
 = 
	`ngx_·Îoc
(
r
->
poÞ
, (
ngx_h‰p_my‹¡_ùx_t
));

429 ià(
myùx
 =ð
NULL
)

431  
NGX_ERROR
;

434 
	`ngx_h‰p_£t_ùx
(
r
, 
myùx
, 
ngx_h‰p_my‹¡_moduË
);

438 ià(
	`ngx_h‰p_up¡»am_ü—‹
(
r
è!ð
NGX_OK
)

440 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0, "ngx_http_upstream_create() failed");

441  
NGX_ERROR
;

445 
ngx_h‰p_my‹¡_cÚf_t
 *
mycf
 = (ngx_h‰p_my‹¡_cÚf_ˆ*è
	`ngx_h‰p_g‘_moduË_loc_cÚf
(
r
, 
ngx_h‰p_my‹¡_moduË
);

446 
ngx_h‰p_up¡»am_t
 *
u
 = 
r
->
up¡»am
;

448 
u
->
cÚf
 = &
mycf
->
up¡»am
;

450 
u
->
bufãršg
 = 
mycf
->
up¡»am
.buffering;

453 
u
->
»sÞved
 = (
ngx_h‰p_up¡»am_»sÞved_t
*è
	`ngx_pÿÎoc
(
r
->
poÞ
, (ngx_http_upstream_resolved_t));

454 ià(
u
->
»sÞved
 =ð
NULL
)

456 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

457 "ngx_pÿÎoø»sÞvedƒ¼Ü. %s.", 
	`¡»¼Ü
(
”ºo
));

458  
NGX_ERROR
;

462 
sockaddr_š
 
back’dSockAddr
;

463 
ho¡’t
 *
pHo¡
 = 
	`g‘ho¡byÇme
((*) "www.google.com");

464 ià(
pHo¡
 =ð
NULL
)

466 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
r
->
cÚÃùiÚ
->
log
, 0,

467 "g‘ho¡byÇmçž. %s", 
	`¡»¼Ü
(
”ºo
));

469  
NGX_ERROR
;

473 
back’dSockAddr
.
sš_çmžy
 = 
AF_INET
;

474 
back’dSockAddr
.
sš_pÜt
 = 
	`htÚs
((
š_pÜt_t
) 80);

475 * 
pDmsIP
 = 
	`š‘_Áß
(*(
š_addr
*è(
pHo¡
->
h_addr_li¡
[0]));

476 
back’dSockAddr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
pDmsIP
);

477 
myùx
->
back’dS”v”
.
d©a
 = (
u_ch¬
*)
pDmsIP
;

478 
myùx
->
back’dS”v”
.
Ën
 = 
	`¡¾’
(
pDmsIP
);

481 
u
->
»sÞved
->
sockaddr
 = (sockadd¸*)&
back’dSockAddr
;

482 
u
->
»sÞved
->
sockËn
 = (
sockaddr_š
);

483 
u
->
»sÞved
->
Çddrs
 = 1;

486 
u
->
ü—‹_»que¡
 = 
my‹¡_up¡»am_ü—‹_»que¡
;

487 
u
->
´oûss_h—d”
 = 
my‹¡_´oûss_¡©us_lše
;

488 
u
->
fš®ize_»que¡
 = 
my‹¡_up¡»am_fš®ize_»que¡
;

491 
r
->
maš
->
couÁ
++;

493 
	`ngx_h‰p_up¡»am_š™
(
r
);

495  
NGX_DONE
;

496 
	}
}

	@
1
.
1
/usr/include
1
25
ngx_http_mytest_module.c
